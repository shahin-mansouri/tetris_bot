
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØ±ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±</title>
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
</head>
<body>
    {% csrf_token %}
    {% comment %} <h1>Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...</h1> {% endcomment %}
    <pre id="log" style="display: none"></pre>



    <script>
        function logMessage(message) {
            document.getElementById("log").textContent += message + "\n";
        }

        function autoLogin() {

            logMessage("ğŸ”„ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ù„Ø§Ú¯ÛŒÙ†...");
            
            // if (typeof window.Telegram !== "undefined" && window.Telegram.WebApp) {
                logMessage("âœ… Telegram.WebApp Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.");
                logMessage("â„¹ï¸ Ù…Ù‚Ø¯Ø§Ø± initDataUnsafe:");
                // logMessage(JSON.stringify(window.Telegram.WebApp.initDataUnsafe, null, 2));
                const initData = Telegram.WebApp.initData;
                logMessage(initData);
                logMessage(Boolean(initData));

                // if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                    let user = window.Telegram.WebApp.initDataUnsafe.user;
                    logMessage("âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:");
                    logMessage(JSON.stringify(user, null, 2));

                    fetch("{% url 'verify_user' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCsrfToken(),
                        },
                        body: JSON.stringify(user),
                    })
                    .then(response => response.json())
                    .then(data => {
                        logMessage("ğŸ“¨ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:");
                        logMessage(JSON.stringify(data, null, 2));
                        if (data.success) {
                            logMessage("âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚! Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯...");
                            {% comment %} window.location.href = "{% url 'home' %}"; {% endcomment %}
                            
                            redirect = String(data.redirect)
                            window.location.href = `/${redirect}`;
                        } else {
                            logMessage("âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: " + (data.error || "Ù†Ø§Ù…Ø´Ø®Øµ"));
                        }
                    })
                    .catch(error => logMessage("âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: " + error));
                //  }else {
                //     logMessage("âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.");
                // }
            // } else {
            //     logMessage("âŒ Telegram.WebApp Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯!");
            // }
        }

        function getCsrfToken() {
          return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        document.addEventListener("DOMContentLoaded", autoLogin);
    </script>
</body>
</html>